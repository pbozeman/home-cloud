{
  inputs.nixpkgs.url = "nixpkgs/nixos-unstable";

  outputs = { nixpkgs, ... }: {
    %{ for host, values in nodes ~}
    nixosConfigurations.${host} = let
      hostname = "${host}";
      hostId = "${values.host_id}";
      kopiaAuth = builtins.fromJSON ''${jsonencode(kopia)}'';

    in nixpkgs.lib.nixosSystem {
      system = "x86_64-linux";
      specialArgs = {
        inherit hostname hostId kopiaAuth;
      };
      modules = [
        ./nas.nix
      ];
    };
    %{ endfor ~}
  };
}
